<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ME — Admin Dashboard</title>
  <style>
    :root{
      --bg:#071428; --panel:#0f1726; --muted:#98a0b3; --accent:#5b69f2; --success:#47d18b; --danger:#ff6b6b;
      --glass: rgba(255,255,255,0.03); --radius:12px; --mono: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
    }
    *{box-sizing:border-box}
    body{
      margin:0; min-height:100vh; font-family:var(--mono); color:#eaf2ff;
      background:linear-gradient(180deg,#041026 0%, #071428 100%);
      padding:20px;
    }

    .container{max-width:1200px;margin:0 auto;display:grid;grid-template-columns:260px 1fr;gap:18px;align-items:start}
    header{grid-column:1/-1;display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:12px}
    .brand{display:flex;gap:12px;align-items:center}
    .logo{width:56px;height:56px;border-radius:10px;background:linear-gradient(135deg,var(--accent),#3a4fe0);display:flex;align-items:center;justify-content:center;font-weight:700}
    h1{margin:0;font-size:18px}
    header .actions{display:flex;gap:8px;align-items:center}

    .panel{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border:1px solid rgba(255,255,255,0.04); padding:14px; border-radius:var(--radius)}
    .sidebar{display:flex;flex-direction:column;gap:12px}
    .small{font-size:13px;color:var(--muted)}
    .cred{padding:10px;border-radius:10px;background:rgba(255,255,255,0.02);border:1px dashed rgba(255,255,255,0.03)}
    .btn{padding:10px 12px;border-radius:8px;border:none;background:linear-gradient(90deg,var(--accent),#4f5df1);color:white;cursor:pointer;font-weight:600}
    .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--accent)}
    .muted{color:var(--muted)}

    /* admin content */
    .content{display:flex;flex-direction:column;gap:12px}
    .grid-2{display:grid;grid-template-columns:1fr 380px;gap:12px}
    label{display:block;font-size:13px;margin-bottom:6px}
    input[type=text], input[type=number], select, textarea{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:inherit}
    textarea{min-height:86px;resize:vertical}
    .uploader{padding:10px;border-radius:10px;border:1px dashed rgba(255,255,255,0.04);background:rgba(255,255,255,0.01)}
    .thumbs{display:flex;gap:10px;flex-wrap:wrap;margin-top:8px}
    .thumb{width:96px;height:96px;border-radius:8px;overflow:hidden;border:1px solid rgba(255,255,255,0.04);display:flex;align-items:center;justify-content:center;position:relative}
    .thumb img{width:100%;height:100%;object-fit:cover}
    .thumb .rm{position:absolute;top:6px;right:6px;background:rgba(0,0,0,0.6);padding:4px;border-radius:6px;cursor:pointer;font-size:12px}
    .controls{display:flex;gap:8px;margin-top:10px}

    table{width:100%;border-collapse:collapse}
    th,td{padding:8px;border-bottom:1px solid rgba(255,255,255,0.03);font-size:13px;text-align:left}
    .tag{display:inline-block;padding:6px 8px;border-radius:999px;background:rgba(255,255,255,0.03);font-size:12px}

    /* toasts */
    .toasts{position:fixed;right:18px;bottom:18px;display:flex;flex-direction:column;gap:8px;z-index:9999}
    .toast{min-width:260px;padding:10px 12px;border-radius:10px;color:white;box-shadow:0 8px 24px rgba(0,0,0,0.45);display:flex;gap:10px;align-items:center}
    .toast.info{background:rgba(90,110,240,0.95)}
    .toast.success{background:linear-gradient(90deg,var(--success),#2bbf8e)}
    .toast.error{background:linear-gradient(90deg,var(--danger),#ff8b6b)}
    .toast .title{font-weight:700;font-size:13px}
    .toast .msg{font-size:13px;color:rgba(0,0,0,0.85)}

    @media (max-width:1000px){
      .container{grid-template-columns:1fr; padding:12px}
      .grid-2{grid-template-columns:1fr}
    }
  </style>
</head>
<body>

  <div class="container">
    <header>
      <div class="brand">
        <div class="logo">ME</div>
        <div>
          <h1>Admin Dashboard — ME</h1>
          <div class="small">Welcome, admin — manage dataset & uploads</div>
        </div>
      </div>
      <div class="actions">
        <div id="stats" class="small muted">Entries: 0</div>
        <button id="btnExport" class="btn ghost">Export CSV</button>
        <button id="logout" class="btn">Logout</button>
      </div>
    </header>

    <!-- left sidebar -->
    <aside class="panel sidebar">
      <div class="panel cred">
        <div style="display:flex;justify-content:space-between"><div class="small">Signed in as</div><strong>admin</strong></div>
        <div style="margin-top:6px" class="small muted">Demo session (client-side). Replace with server auth for production.</div>
      </div>

      <div class="panel">
        <div class="small">Quick Actions</div>
        <div style="display:flex;gap:8px;margin-top:10px">
          <button id="btnUploadServer" class="btn">Send to Server</button>
          <button id="btnClearAll" class="btn ghost">Clear all</button>
        </div>
      </div>

      <div class="panel muted">
        <div style="font-weight:700">Notes</div>
        <div class="small" style="margin-top:6px">Images are stored as base64 in localStorage (demo). For production upload files to server or cloud storage and store URLs in CSV.</div>
      </div>
    </aside>

    <!-- main content -->
    <main class="panel content">
      <div class="grid-2">
        <section class="panel">
          <h3 style="margin:0 0 8px">Add new sample(s)</h3>
          <div class="small muted" style="margin-bottom:10px">Choose image(s) and attach metadata.</div>

          <label>Text / Post</label>
          <textarea id="metaText" placeholder="Enter post text or notes"></textarea>

          <div style="display:flex;gap:10px;margin-top:8px">
            <div style="flex:1">
              <label>Label</label>
              <select id="metaLabel">
                <option value="none">none</option>
                <option value="mild">mild</option>
                <option value="moderate">moderate</option>
                <option value="severe">severe</option>
              </select>
            </div>
            <div style="width:140px">
              <label>Score (0.00 - 1.00)</label>
              <input id="metaScore" type="number" min="0" max="1" step="0.01" value="0.00">
            </div>
          </div>

          <div style="margin-top:10px">
            <label>Choose image files</label>
            <div class="uploader">
              <input id="fileInput" type="file" accept="image/*" multiple>
              <div class="thumbs" id="preview"></div>
            </div>
            <div class="controls">
              <button id="addBtn" class="btn">Add to dataset</button>
              <button id="clearSelection" class="btn ghost">Clear selection</button>
              <button id="fillDemo" class="btn ghost">Fill demo</button>
            </div>
          </div>
        </section>

        <aside class="panel">
          <h3 style="margin:0 0 8px">Quick tips</h3>
          <div class="small muted">- Select multiple images to create multiple entries sharing the same metadata.<br>
          - Image base64 data can make storage large — upload to server/cloud and store URLs instead.<br>
          - Use Send to Server to POST dataset JSON to your backend (placeholder).</div>

          <div style="margin-top:12px">
            <div class="small">Current dataset size</div>
            <div id="countBig" style="font-size:22px;font-weight:700;margin-top:6px">0</div>
          </div>
        </aside>
      </div>

      <section class="panel" style="overflow:auto">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <h3 style="margin:0">Dataset entries</h3>
          <div class="small muted">You can delete rows or download images</div>
        </div>

        <table id="datasetTable" style="margin-top:10px">
          <thead>
            <tr><th style="width:38px">#</th><th>Preview</th><th>Text</th><th>Label</th><th>Score</th><th>Actions</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </section>
    </main>
  </div>

  <!-- toasts -->
  <div class="toasts" id="toasts"></div>

  <script>
    // Admin dashboard client-side dataset manager
    const STORAGE_KEY = 'me_admin_dataset_v1';
    const fileInput = document.getElementById('fileInput');
    const preview = document.getElementById('preview');
    const addBtn = document.getElementById('addBtn');
    const clearSelection = document.getElementById('clearSelection');
    const metaText = document.getElementById('metaText');
    const metaLabel = document.getElementById('metaLabel');
    const metaScore = document.getElementById('metaScore');
    const datasetTableBody = document.querySelector('#datasetTable tbody');
    const toasts = document.getElementById('toasts');
    const btnExport = document.getElementById('btnExport');
    const btnUploadServer = document.getElementById('btnUploadServer');
    const btnClearAll = document.getElementById('btnClearAll');
    const logoutBtn = document.getElementById('logout');
    const fillDemo = document.getElementById('fillDemo');
    const countBig = document.getElementById('countBig');
    const stats = document.getElementById('stats');

    let selectionFiles = [];
    let dataset = loadDataset();

    init();

    function init() {
      renderDataset();
      updateCounts();
    }

    // Toast helper
    function toast(message, type='info', title='') {
      const el = document.createElement('div');
      el.className = 'toast ' + (type==='error'?'error':type==='success'?'success':'info');
      el.innerHTML = `<div style="flex:1"><div class="title">${title || (type==='error'?'Error': type==='success'?'Success':'Info')}</div><div class="msg" style="margin-top:6px">${message}</div></div><div style="margin-left:8px;cursor:pointer;font-weight:700">✕</div>`;
      el.querySelector('div[style*="cursor"]').addEventListener('click', ()=>el.remove());
      toasts.appendChild(el);
      setTimeout(()=>{ if (el.parentNode) el.remove(); }, 6000);
    }

    // File input preview
    fileInput.addEventListener('change', async (e) => {
      const files = Array.from(e.target.files || []);
      selectionFiles = [];
      preview.innerHTML = '';
      for (const f of files) {
        if (!f.type.startsWith('image/')) { toast('Only images allowed', 'error'); continue; }
        if (f.size > 6*1024*1024) { toast(`File ${f.name} > 6MB skipped`, 'error'); continue; }
        try {
          const dataUrl = await fileToDataURL(f);
          selectionFiles.push({file:f, dataUrl});
          preview.appendChild(thumbElement(dataUrl));
        } catch (err) {
          console.error(err);
          toast('Failed to read file', 'error');
        }
      }
    });

    function fileToDataURL(file) {
      return new Promise((res, rej) => {
        const r = new FileReader();
        r.onload = () => res(r.result);
        r.onerror = rej;
        r.readAsDataURL(file);
      });
    }

    function thumbElement(dataUrl) {
      const el = document.createElement('div');
      el.className = 'thumb';
      el.innerHTML = `<img src="${dataUrl}" alt="preview"><div class="rm" title="Remove">✕</div>`;
      el.querySelector('.rm').addEventListener('click', () => {
        selectionFiles = selectionFiles.filter(s => s.dataUrl !== dataUrl);
        el.remove();
        fileInput.value = '';
      });
      return el;
    }

    clearSelection.addEventListener('click', () => {
      selectionFiles = [];
      preview.innerHTML = '';
      fileInput.value = '';
    });

    // Add selected images to dataset
    addBtn.addEventListener('click', () => {
      if (selectionFiles.length === 0) { toast('No images selected', 'error'); return; }
      const text = metaText.value.trim();
      const label = metaLabel.value;
      const score = Number(metaScore.value) || 0.0;
      const ts = new Date().toISOString();
      for (const s of selectionFiles) {
        dataset.push({
          id: 'r' + Math.random().toString(36).slice(2,9),
          text, label, score,
          filename: s.file.name,
          imageData: s.dataUrl,
          ts
        });
      }
      saveDataset();
      renderDataset();
      updateCounts();
      toast(`${selectionFiles.length} sample(s) added`, 'success');
      selectionFiles = []; preview.innerHTML=''; fileInput.value='';
    });

    // Save/load localStorage
    function saveDataset() {
      try { localStorage.setItem(STORAGE_KEY, JSON.stringify(dataset)); }
      catch (e) { console.error(e); toast('Failed to save in localStorage', 'error'); }
    }
    function loadDataset() {
      try { const raw = localStorage.getItem(STORAGE_KEY); return raw?JSON.parse(raw):[]; }
      catch (e) { console.error(e); return []; }
    }

    // Render dataset table
    function renderDataset() {
      datasetTableBody.innerHTML = '';
      dataset.forEach((r, i) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${i+1}</td>
          <td style="width:110px"><div style="width:86px;height:56px;overflow:hidden;border-radius:6px;border:1px solid rgba(255,255,255,0.04)"><img src="${r.imageData}" style="width:100%;height:100%;object-fit:cover"></div></td>
          <td>${escapeHtml(r.text||'')}</td>
          <td><span class="tag">${r.label}</span></td>
          <td>${Number(r.score||0).toFixed(2)}</td>
          <td>
            <button data-id="${r.id}" class="btn ghost del">Delete</button>
            <button data-id="${r.id}" class="btn ghost dl">Download</button>
          </td>
        `;
        datasetTableBody.appendChild(tr);
      });

      // attach listeners
      document.querySelectorAll('.del').forEach(b => b.addEventListener('click', e => {
        const id = e.currentTarget.dataset.id;
        if (!confirm('Delete this entry?')) return;
        dataset = dataset.filter(x => x.id !== id);
        saveDataset(); renderDataset(); updateCounts();
        toast('Entry deleted', 'info');
      }));
      document.querySelectorAll('.dl').forEach(b => b.addEventListener('click', e => {
        const id = e.currentTarget.dataset.id;
        const row = dataset.find(x => x.id === id);
        if (!row) return toast('Not found', 'error');
        downloadDataUrlImage(row.imageData, row.filename || (row.id + '.png'));
      }));
    }

    function downloadDataUrlImage(dataUrl, filename) {
      const a = document.createElement('a');
      a.href = dataUrl;
      a.download = filename;
      document.body.appendChild(a);
      a.click(); a.remove();
    }

    // Export CSV
    btnExport.addEventListener('click', () => {
      if (dataset.length === 0) { toast('Dataset is empty', 'error'); return; }
      const rows = [['id','text','label','score','filename','imageData','ts']];
      dataset.forEach(r => rows.push([r.id, r.text||'', r.label, r.score||0, r.filename||'', r.imageData||'', r.ts||'']));
      const csv = rows.map(r => r.map(cell => `"${String(cell).replace(/"/g,'""')}"`).join(',')).join('\n');
      const blob = new Blob([csv], {type: 'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'me_dataset.csv'; document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url); toast('CSV exported', 'success');
    });

    // Send to server (placeholder)
    btnUploadServer.addEventListener('click', async () => {
      if (dataset.length === 0) { toast('Dataset empty', 'error'); return; }
      try {
        toast('Sending to server (demo)...', 'info');
        const res = await fetch('/api/admin/upload', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({dataset})
        });
        if (!res.ok) throw new Error('Server error '+res.status);
        const j = await res.json();
        toast('Server: ' + (j.message || 'OK'), 'success');
      } catch (e) {
        console.error(e);
        toast('Failed to send to server. See console.', 'error');
      }
    });

    // Clear all dataset
    btnClearAll.addEventListener('click', () => {
      if (!confirm('Clear all dataset entries? This will remove them from localStorage.')) return;
      dataset = []; saveDataset(); renderDataset(); updateCounts(); toast('All entries cleared', 'info');
    });

    // Logout
    logoutBtn.addEventListener('click', () => {
      // In demo simply redirect to login page
      location.href = 'login.html';
    });

    // Fill demo
    fillDemo.addEventListener('click', () => {
      metaText.value = 'I feel hopeless and tired all the time.';
      metaLabel.value = 'severe';
      metaScore.value = '0.92';
      // small SVG demo image
      const svg = `<svg xmlns='http://www.w3.org/2000/svg' width='400' height='300'><rect width='100%' height='100%' fill='#f0f4ff'/><text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' fill='#333'>demo image</text></svg>`;
      const dataUrl = 'data:image/svg+xml;base64,' + btoa(svg);
      selectionFiles = [{file:{name:'demo.svg'}, dataUrl}];
      preview.innerHTML = ''; preview.appendChild(thumbElement(dataUrl));
    });

    // Utility functions
    function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
    function updateCounts(){ countBig.textContent = dataset.length; stats.textContent = 'Entries: ' + dataset.length; }
    function thumbElement(dataUrl){
      const el = document.createElement('div'); el.className='thumb';
      el.innerHTML = `<img src="${dataUrl}" alt="thumb"><div class="rm" title="Remove">✕</div>`;
      el.querySelector('.rm').addEventListener('click', ()=>{ selectionFiles = selectionFiles.filter(s=>s.dataUrl !== dataUrl); el.remove(); fileInput.value=''; });
      return el;
    }

    function fileToDataURL(file){ return new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(file); }); }

    // Update dataset when files selected
    fileInput.addEventListener('change', async (e) => {
      const files = Array.from(e.target.files || []);
      selectionFiles = []; preview.innerHTML='';
      for (const f of files) {
        if (!f.type.startsWith('image/')) { toast('Only images are allowed', 'error'); continue; }
        if (f.size > 6*1024*1024) { toast(`File ${f.name} > 6MB skipped`, 'error'); continue; }
        try { const dataUrl = await fileToDataURL(f); selectionFiles.push({file:f, dataUrl}); preview.appendChild(thumbElement(dataUrl)); }
        catch (err) { console.error(err); toast('Failed to read file', 'error'); }
      }
    });

    function loadDataset(){ try { const raw = localStorage.getItem(STORAGE_KEY); return raw?JSON.parse(raw):[]; } catch(e){ console.error(e); return []; } }
    function saveDataset(){ try { localStorage.setItem(STORAGE_KEY, JSON.stringify(dataset)); } catch(e){ console.error(e); toast('localStorage save failed', 'error'); } }
    function renderDataset(){ /* already defined earlier, but refresh table */ datasetTableBody.innerHTML=''; dataset.forEach((r,i)=>{ const tr=document.createElement('tr'); tr.innerHTML = `<td>${i+1}</td><td style="width:110px"><div style="width:86px;height:56px;overflow:hidden;border-radius:6px;border:1px solid rgba(255,255,255,0.04)"><img src="${r.imageData}" style="width:100%;height:100%;object-fit:cover"></div></td><td>${escapeHtml(r.text||'')}</td><td><span class="tag">${r.label}</span></td><td>${Number(r.score||0).toFixed(2)}</td><td><button data-id="${r.id}" class="btn ghost del">Delete</button> <button data-id="${r.id}" class="btn ghost dl">Download</button></td>`; datasetTableBody.appendChild(tr); }); attachRowListeners(); }

    function attachRowListeners(){
      document.querySelectorAll('.del').forEach(b=>b.onclick=(e)=>{ const id=e.currentTarget.dataset.id; if(!confirm('Delete this entry?')) return; dataset=dataset.filter(x=>x.id!==id); saveDataset(); renderDataset(); updateCounts(); toast('Deleted','info'); });
      document.querySelectorAll('.dl').forEach(b=>b.onclick=(e)=>{ const id=e.currentTarget.dataset.id; const r=dataset.find(x=>x.id===id); if(!r) return toast('Not found','error'); downloadDataUrlImage(r.imageData,r.filename||r.id+'.png'); });
    }
    function downloadDataUrlImage(dataUrl,filename){ const a=document.createElement('a'); a.href=dataUrl; a.download=filename; document.body.appendChild(a); a.click(); a.remove(); }

    // initial render (call again to attach events)
    renderDataset();
    updateCounts();

  </script>
</body>
</html>
